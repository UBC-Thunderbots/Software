---

- name: Robot Auto Test Playbook
  hosts: THUNDERBOTS_HOSTS

  tasks:

    - debug:
        msg: "[Robot ID = {{ inventory_hostname }}]"
      tags: always

    - name: Start Robot Auto Test Process
      block:

        - name: Stop Services
          become: true
          become_method: sudo
          ansible.builtin.systemd:
              name: "thunderloop.service"
              masked: no
              daemon_reload: yes
              state: stopped
          tags: always

        - name: Delete everything on ~/
          file:
            state: absent
            path: ~/thunderbots_binaries/robot_auto_test
          become_method: sudo
          become: true
          register: result

        - debug:
            msg: "{{ansible_search_path}}"
          tags: always

        - name: Sync Binaries
          ansible.posix.synchronize:
            src: /home/joshua/Repositories/Thunderbots/Software/src/bazel-bin/software/jetson_nano/services/robot_auto_test
#            src: ../../../services/robot_auto_test
            dest: ~/thunderbots_binaries/
            recursive: yes
            copy_links: yes
#          with_items: "{{ services }}"
#          loop_control:
#            loop_var: service_name
#          when: "'sync' in actions"
          tags: always
#
#        - name: Unzipping python binaries
#          command: 'unzip ~/thunderbots_binaries/*.zip'
#          register: result
#          args:
#            chdir: ~/thunderbots_binaries
#          when: "'sync' in actions"
#          ignore_errors: yes # Remove when display is re-enabled

#        - name: Start Services
#          become: true
#          become_method: sudo
#          ansible.builtin.systemd:
#            name: "{{ service_name }}"
#            masked: no
#            daemon_reload: yes
#            state: started
#          with_items: "{{ services }}"
#          loop_control:
#            loop_var: service_name
#          when: "'start' in actions"
#          tags: always
