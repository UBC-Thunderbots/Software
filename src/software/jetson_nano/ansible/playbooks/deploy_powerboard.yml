---

- name: Deploy to the powerboard
  hosts: THUNDERBOTS_HOSTS

  tasks:
    - name: Sync powerboard files
      become: true
      become_method: sudo
      ansible.posix.synchronize:
        src: ../../../../../power/powerloop.tar.gz
        dest: ~/
        recursive: yes
        copy_links: yes

    - name: Untar powerboard files
      shell: 'mkdir -p powerloop && tar -xvf ~/powerloop.tar.gz -C powerloop'
      register: result
      args:
        chdir: ~/

    - name: Enter bootloader mode
      script: ../scripts/esp32_flashing.py bootloader
      args:
        executable: /opt/tbotspython/bin/python
      register: result

    - debug: msg="{{ result.stdout }}"

    - name: Flashing... (this will take a while on the first run)
      #shell: '/opt/tbotspython/bin/platformio run --disable-auto-clean -t nobuild -t upload -d ~/powerloop/power'
      shell: '/opt/tbotspython/bin/esptool.py --chip esp32 --port /dev/ttyTHS1 --baud 115200 --before default_reset --after hard_reset --no-stub write_flash -z --flash_mode dio --flash_freq 40m --flash_size 4MB --spi-connection=6,17,8,11,16 0x10000 ~/powerloop/power/.pio/build/pico32/firmware.bin'
      register: result

    - name: Reset powerboard to finish flashing
      script: ../scripts/esp32_flashing.py reset
      args:
        executable: /opt/tbotspython/bin/python
      register: result

