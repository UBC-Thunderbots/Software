---

- name: Sync Setup Script
  become: true
  become_method: sudo
  ansible.posix.synchronize:
    src: ../../setup_robot_software_deps.sh
    dest: ~/
    copy_links: yes

# Output is streamed to target host's (Jetson/Pi's /tmp/setup.log)
- name: Running the setup script, this will take a while
  become_method: sudo
  become: true
  command: '/home/{{ ansible_user }}/setup_robot_software_deps.sh >& /tmp/setup.log'
  register: result
  args:
    chdir: ~/

- name: Configure Redis persistence setting
  become: true
  become_method: sudo
  ansible.builtin.lineinfile:
    path: /etc/redis/redis.conf
    state: present
    regexp: ^(appendonly)
    line: 'appendonly yes'
    backrefs: yes

- name: Disable WiFi power management
  block:
    - name: Delete WiFi power management rule
      become: true
      become_method: sudo
      ansible.builtin.file:
        path: /etc/NetworkManager/conf.d/default-wifi-powersave-on.conf
        state: absent

    - name: Create WiFi power management rule
      become: true
      become_method: sudo
      ansible.builtin.copy:
        content: |
          [connection]
          wifi.powersave = 2
        dest: /etc/NetworkManager/conf.d/default-wifi-powersave-on.conf
        mode: '600'
